"use client";

import { useState, useCallback } from "react";
import { apiRoutes } from "@/lib/apiRoutes";

type Props = {
  activityId: string;
  onDone?: (id: string) => void;
};

type ErrorBody = { detail?: string };

// parse JSON ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
function parseJsonSafe<T>(text: string): T | null {
  try {
    return text ? (JSON.parse(text) as T) : null;
  } catch {
    return null;
  }
}

// ‡∏î‡∏∂‡∏á message ‡∏à‡∏≤‡∏Å error ‡πÅ‡∏ö‡∏ö type-safe
function getErrorMessage(e: unknown): string {
  if (e instanceof Error) return e.message;
  if (typeof e === "string") return e;
  return "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏";
}

export default function AddToLifeButton({ activityId, onDone }: Props) {
  const [loading, setLoading] = useState(false);

  const handleAdd = useCallback(async () => {
    if (!activityId) {
      alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°");
      return;
    }
    if (!window.confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï?")) return;

    try {
      setLoading(true);

      const res = await fetch(apiRoutes.addActivityToMyLife, {
        method: "POST",
        credentials: "include",
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ activity_id: activityId }),
        cache: "no-store",
      });

      const text = await res.text().catch(() => "");
      const data = parseJsonSafe<ErrorBody>(text);

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï
      if (res.status === 401) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
      if (res.status === 409) throw new Error("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß");
      if (res.status === 422) throw new Error("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (activity_id)");
      if (!res.ok) {
        const msg = data?.detail || `‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (${res.status})`;
        throw new Error(msg);
      }

      alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ");
      onDone?.(activityId); // ‚úÖ ‡∏™‡πà‡∏á id ‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ
    } catch (e: unknown) {
      console.error(e);
      alert(getErrorMessage(e) || "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
    } finally {
      setLoading(false);
    }
  }, [activityId, onDone]);

  return (
    <button
      type="button"
      onClick={handleAdd}
      disabled={loading}
      className="px-6 py-3 rounded-full bg-[#B30000] hover:bg-[#880000] disabled:opacity-60 text-white font-bold shadow-md transition"
    >
      {loading ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°..." : "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï"}
    </button>
  );
}
